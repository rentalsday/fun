<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dollar Vibes ‚Ä¢ $ ‚Üí Fun</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #f0f0ff;
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      box-sizing: border-box;
    }
    h1 {
      font-size: clamp(2.5rem, 8vw, 3.5rem);
      margin: 0.5rem 0 0.8rem;
      background: linear-gradient(90deg, #a78bfa, #7dd3fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .input-area {
      display: flex;
      gap: 1rem;
      margin: 1.5rem 0 2rem;
      width: 100%;
      max-width: 500px;
      justify-content: center;
    }
    input {
      font-size: clamp(1.8rem, 6vw, 2.2rem);
      width: 160px;
      padding: 0.7rem 1rem;
      border: 2px solid #6b7280;
      border-radius: 12px;
      background: #1e1b38;
      color: white;
      text-align: center;
    }
    button {
      font-size: clamp(1.3rem, 5vw, 1.6rem);
      padding: 0.8rem 2rem;
      border: none;
      border-radius: 12px;
      background: #7c3aed;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { background: #9f7aea; transform: translateY(-2px); }
    
    #result {
      max-width: 700px;
      background: rgba(30, 27, 56, 0.75);
      backdrop-filter: blur(8px);
      padding: 1.8rem 2rem;
      border-radius: 16px;
      line-height: 1.6;
      font-size: clamp(1.1rem, 4vw, 1.3rem);
      border: 1px solid #4b5563;
      min-height: 160px;
      white-space: pre-wrap;
      text-align: left;
    }
    
    .emoji { font-size: 1.8rem; margin-right: 0.4rem; }

    @media (max-width: 600px) {
      body { padding: 1.5rem 1rem; }
      .input-area { flex-direction: column; align-items: center; gap: 1rem; }
      input, button { width: 80%; max-width: 300px; }
    }
  </style>
</head>
<body>

  <h1>Budget Vibes</h1>
  <p style="opacity:0.8; margin-top:-0.8rem; text-align:center;">Turn any dollar amount into instant fun ideas</p>

  <div class="input-area">
    <input type="number" id="budget" placeholder="50" min="1" step="1" autofocus>
    <button onclick="generateIdeas()">Go!</button>
  </div>

  <div id="result">Detecting your location for personalized vibes... <br>Enter an amount and hit Go! ‚ú®</div>

  <script>
    const resultDiv = document.getElementById('result');
    const input = document.getElementById('budget');

    let userLocation = ''; // Start empty ‚Üí will be set by geolocation

    // Try to get real user location on page load (non-blocking)
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&zoom=10&addressdetails=1`);
          const data = await res.json();
          const city = data.address?.city || data.address?.town || data.address?.village || data.address?.hamlet || '';
          const state = data.address?.state || data.address?.province || data.address?.region || '';
          const country = data.address?.country_code?.toUpperCase() || '';
          
          if (city && state) {
            userLocation = `${city}, ${state} ${country}`.trim();
            console.log('Accurate location detected:', userLocation);
            // Optional: update UI to show location was found
            resultDiv.innerHTML = resultDiv.innerHTML.replace(
              'Detecting your location...',
              `Using your location: ${userLocation} ‚ú®<br>`
            );
          } else if (data.display_name) {
            userLocation = data.display_name.split(', ').slice(-3).join(', ');
          }
        } catch (err) {
          console.log('Geolocation reverse lookup failed:', err);
        }
      }, (err) => {
        console.log('User denied geolocation or error:', err.message);
        resultDiv.innerHTML = resultDiv.innerHTML.replace(
          'Detecting your location...',
          'Location access denied or unavailable ‚Äî using general suggestions üåç<br>'
        );
      }, { timeout: 8000, enableHighAccuracy: false });
    } else {
      console.log('Browser does not support geolocation');
      resultDiv.innerHTML = resultDiv.innerHTML.replace(
        'Detecting your location...',
        'Geolocation not supported by this browser ‚Äî using general suggestions üåç<br>'
      );
    }

    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') generateIdeas();
    });

    async function generateIdeas() {
      const dollars = parseInt(input.value) || 0;
      if (dollars < 1) {
        resultDiv.innerHTML = "üí∏ At least give me <strong>$1</strong> to work with...";
        return;
      }

      resultDiv.innerHTML = "Brewing some üî• local vibes... hold on ‚è≥";

      try {
        const response = await fetch("/api/proxy", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "grok-4",  // Change if your key supports a different model
            messages: [
              {
                role: "system",
                content: `You are a super fun, creative, slightly chaotic friend wherever the user is located.
                Turn any budget into exciting gun links to online games to kill time while at work or school or in bed at home
                Use lots of emojis. Give 4‚Äì6 specific ideas. Sort roughly from cheapest to most expensive (all ‚â§ budget).
                Include one mildly unhinged / legendary suggestion.
                Tailor suggestions to the user's actual location if provided, otherwise use general ideas suitable for most places.`
              },
              {
                role: "user",
                content: `Budget: $${dollars} or less. Location: ${userLocation || 'unknown / anywhere in the world'}. Suggest fun, doable things right now or this weekend.`
              }
            ],
            temperature: 0.92,
            max_tokens: 320
          })
        });

        if (!response.ok) {
          throw new Error(`Request failed: ${response.status}`);
        }

        const data = await response.json();
        let reply = data.choices?.[0]?.message?.content?.trim() || "Hmm... the vibes are quiet today üòÖ";

        // Simple formatting improvement
        reply = reply.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        resultDiv.innerHTML = reply;

      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `Oops ‚Äî vibes check failed üò≠<br><br>
          <small>Error: ${err.message}<br>
          ‚Ä¢ Make sure /api/proxy.js exists in your repo<br>
          ‚Ä¢ Check that XAI_API_KEY is set correctly in Vercel ‚Üí Settings ‚Üí Environment Variables<br>
          ‚Ä¢ View Vercel function logs for more details</small>`;
      }
    }
  </script>

</body>
</html>
